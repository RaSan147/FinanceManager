{% extends "base.html" %}

{#
Transactions page
Renders a paginated table of user transactions. Minimal logic is kept in the
template; JavaScript will handle pagination and in-place editing using the
data attributes provided on the table container and action buttons.
#}

{% block title %}Transactions{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between transactions-header flex-nowrap">
    <h4 class="card-title mb-0">Transactions</h4>
    <div class="header-actions d-flex gap-2">
      <button
        type="button"
        class="btn btn-light add-transaction-btn"
        data-open-tx-modal
        aria-label="Add Transaction"
        title="Add Transaction">
        <i class="fa-solid fa-plus"></i>
        <span class="d-none d-md-inline ms-1">Add</span>
      </button>
    </div>
  </div>

  <div class="card-body">
    <div
      class="table-responsive"
      data-transactions-table
      data-per-page="{{ per_page }}"
      data-currency-symbol="{{ currency_symbol | default('') }}"
      data-current-page="{{ page }}"
      data-total-transactions="{{ total_transactions | default(0) }}">
      <table class="table table-hover transactions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Category</th>
            <th>Amount ({{ currency_code | default('') }})</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody data-transactions-body>
          {% if transactions %}
          {% for t in transactions %}
          <tr>
            <td data-label="Date">{{ t.date.strftime('%Y-%m-%d') }}</td>
            <td data-label="Description">{{ t.description }}</td>

            {# Category labels come from tx_categories dict; fall back to code #}
            {% set labels = tx_categories.get(t.type, {}).get(t.category, {}) %}
            <td data-label="Category">{{ labels.get(user_language|default('en'), labels.get('en', t.category)) }}</td>

            <td data-label="Amount" class="{{ 'text-success' if t.type == 'income' else 'text-danger' }}">
              {{ '+' if t.type == 'income' else '-' }}{{ currency_symbol }}{{ "{:,.2f}".format(t.amount) }}
            </td>

            <td data-label="Type">{{ t.type|capitalize }}</td>

            <td data-label="Actions" class="d-flex gap-1">
              {# Build a safe JSON payload for the edit button to avoid manual escaping #}
              {% set edit_payload = {
              '_id': t._id|string,
              'amount_original': (t.amount_original|default(t.amount)),
              'currency': t.currency,
              'type': t.type,
              'category': t.category,
              'description': (t.description),
              'date': t.date.strftime('%Y-%m-%d'),
              'related_person': (t.related_person|default(''))
              } %}

              <button
                class="btn btn-sm btn-outline-secondary"
                data-edit-id="{{ t._id }}"
                data-edit-json='{{ edit_payload|tojson|safe }}'>
                <i class="fa-solid fa-pen" aria-hidden="true"></i>
              </button>

              <button class="btn btn-sm btn-danger action-btn" data-delete-id="{{ t._id }}">
                <i class="fa-solid fa-trash" aria-hidden="true"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted" data-label="Info">No transactions</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div data-pagination class="mt-3">
      {# JS will render pagination client-side; provide a basic noscript fallback #}
      <noscript>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if page > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('transactions_routes.transactions', page=page-1) }}">Previous</a>
            </li>
            {% endif %}

            {% set total = (total_transactions or 0) %}
            {% set pages = ((total // per_page) + 1) if total > 0 else 1 %}
            {% for p in range(1, pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('transactions_routes.transactions', page=p) }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if page < pages %}
              <li class="page-item">
              <a class="page-link" href="{{ url_for('transactions_routes.transactions', page=page+1) }}">Next</a>
              </li>
              {% endif %}
          </ul>
        </nav>
      </noscript>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Category labels used by client-side rendering.
  window.txCategoryLabels = ({{ tx_categories|tojson|safe }});
  window.txCategoryLang = ({{ user_language|default('en')|tojson|safe }});

  window.getTxCategoryLabel = function (type, code) {
    try {
      return (window.txCategoryLabels?.[type]?.[code]?.[window.txCategoryLang])
        || (window.txCategoryLabels?.[type]?.[code]?.en)
        || code;
    } catch (_) {
      return code;
    }
  };
</script>
{% endblock %}

{% endblock %}